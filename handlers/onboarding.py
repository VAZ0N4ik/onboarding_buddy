# handlers/onboarding.py
"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
"""
import logging
from telegram import Update
from telegram.ext import ContextTypes

from config.settings import settings
from database.manager import db_manager
from database.models import UserStatus, OnboardingStage
from bot.keyboards import Keyboards
from datetime import datetime
from utils.helpers import format_datetime

logger = logging.getLogger(__name__)


async def handle_onboarding(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞"""
    user_id = update.effective_user.id
    user = db_manager.get_user(user_id)

    if not user:
        await update.message.reply_text(
            "‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."
        )
        return

    db_manager.log_user_action(user_id, "onboarding_access", "–û–±—Ä–∞—Ç–∏–ª—Å—è –∫ —Ä–∞–∑–¥–µ–ª—É –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user.status == UserStatus.NEW:
        text = """
‚ö†Ô∏è –î–ª—è –Ω–∞—á–∞–ª–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–µ–±–æ—Ä–¥–∏–Ω–≥

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª "üöÄ –ü—Ä–µ–±–æ—Ä–¥–∏–Ω–≥" –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

üìã –ß—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ–±–æ—Ä–¥–∏–Ω–≥:
‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚Ä¢ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∫–∞–Ω–æ–≤ HR-–º–µ–Ω–µ–¥–∂–µ—Ä—É  
‚Ä¢ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–±–æ—Ä–¥–∏–Ω–≥–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥—É.
"""
        await update.message.reply_text(text)
        return

    elif user.status == UserStatus.PREBOARDING:
        text = """
üîÑ –ü—Ä–µ–±–æ—Ä–¥–∏–Ω–≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ

–°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ "üöÄ –ü—Ä–µ–±–æ—Ä–¥–∏–Ω–≥".

üìß –ù–µ –∑–∞–±—É–¥—å—Ç–µ:
‚Ä¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ {settings.HR_EMAIL}
‚Ä¢ –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç HR-–º–µ–Ω–µ–¥–∂–µ—Ä–∞
‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω.
"""
        await update.message.reply_text(text)
        return

    elif user.status == UserStatus.COMPLETED:
        text = """
üéâ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω!

–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ –≤—Å–µ —ç—Ç–∞–ø—ã –∞–¥–∞–ø—Ç–∞—Ü–∏–∏.

üìö –ß—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ:
‚Ä¢ ‚ùì FAQ - –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
‚Ä¢ üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞
‚Ä¢ üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∫–æ–ª–ª–µ–≥–∞–º –∏–ª–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É!
"""
        await update.message.reply_text(text)
        return

    # –û—Å–Ω–æ–≤–Ω–æ–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ PREBOARDED –∏ ONBOARDING
    if user.status == UserStatus.PREBOARDED:
        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å—Ç–∞—Ç—É—Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
        db_manager.update_user_stage(user_id, OnboardingStage.ONBOARDING_START, UserStatus.ONBOARDING)

        text = f"""
üéâ –û—Ç–ª–∏—á–Ω–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É {settings.COMPANY_NAME}!

–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ–º –≤ —à—Ç–∞—Ç! 

üìã –ß—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç –æ–Ω–±–æ—Ä–¥–∏–Ω–≥:
‚Ä¢ –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–æ–≤
‚Ä¢ –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–º–∞–Ω–¥–æ–π –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
‚Ä¢ –û–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ —Å —Ä–∞–±–æ—á–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–Ω–µ—Ä–∫–∞—Ö –∏ –≤—Å—Ç—Ä–µ—á–∞—Ö

‚è±Ô∏è –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: 20-30 –º–∏–Ω—É—Ç

üéØ –¶–µ–ª—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞:
–ü–æ–º–æ—á—å –≤–∞–º –±—ã—Å—Ç—Ä–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ —Å—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º —á–ª–µ–Ω–æ–º –∫–æ–º–∞–Ω–¥—ã.

–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–º–ø–∞–Ω–∏–µ–π?
"""
    else:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
        progress_bar = Keyboards.get_progress_visualization(user.stage)

        text = f"""
üöÄ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥

üìä –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å: {user.stage}/10 —ç—Ç–∞–ø–æ–≤
{progress_bar}

üéØ –¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø: {OnboardingStage.get_stage_name(user.stage)}

–ü—Ä–æ–¥–æ–ª–∂–∏–º —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å?
"""

    keyboard = Keyboards.get_start_onboarding()
    await update.message.reply_text(text, reply_markup=keyboard)


async def handle_onboarding_callback(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–æ–≤ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞"""
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id
    callback_data = query.data

    if callback_data == "start_onboarding":
        await start_onboarding_process(query, context)
    elif callback_data == "email_received":
        await handle_email_received(query, context)
    elif callback_data == "email_not_received":
        await handle_email_not_received(query, context)
    elif callback_data == "team_intro":
        await handle_team_intro(query, context)
    elif callback_data == "meetings":
        await handle_meetings_info(query, context)
    elif callback_data == "complete_onboarding":
        await complete_onboarding(query, context)


async def start_onboarding_process(query, context):
    """–ù–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞"""
    user_id = query.from_user.id
    user = db_manager.get_user(user_id)

    # –û–±–Ω–æ–≤–ª—è–µ–º —ç—Ç–∞–ø –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if user.stage < OnboardingStage.EMAIL_ACCESS:
        db_manager.update_user_stage(user_id, OnboardingStage.EMAIL_ACCESS)

    db_manager.log_user_action(user_id, "onboarding_start", "–ù–∞—á–∞–ª –ø—Ä–æ—Ü–µ—Å—Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞")

    text = f"""
üéâ –ù–∞—á–∏–Ω–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥!

üìß –®–∞–≥ 1: –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–æ—á—Ç–∞

–ü–µ—Ä–≤—ã–º –¥–µ–ª–æ–º –≤–∞–º –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ.

–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:
‚Ä¢ HR-–º–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ –Ω–∞ –≤–∞—à—É –ª–∏—á–Ω—É—é –ø–æ—á—Ç—É
‚Ä¢ –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–æ—á—Ç—ã
‚Ä¢ –ß–µ—Ä–µ–∑ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–æ—á—Ç—É –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ä–µ—Å—É—Ä—Å–∞–º

üìß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É! 
–ü–∏—Å—å–º–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ –æ—Ç: {settings.HR_EMAIL}

–í –ø–∏—Å—å–º–µ –±—É–¥—É—Ç:
‚Ä¢ –õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å
‚Ä¢ –°—Å—ã–ª–∫–∏ –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
‚Ä¢ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–µ—Ä–≤–æ–º—É –≤—Ö–æ–¥—É

‚ùì –ü–æ–ª—É—á–∏–ª–∏ –ª–∏ –≤—ã –¥–æ—Å—Ç—É–ø –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–æ—á—Ç–µ?
"""

    keyboard = Keyboards.get_email_access()
    await query.edit_message_text(text, reply_markup=keyboard)


async def handle_email_received(query, context):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—á—Ç–µ"""
    user_id = query.from_user.id

    db_manager.update_user_stage(user_id, OnboardingStage.TEAM_INTRO)
    db_manager.log_user_action(user_id, "email_access_confirmed", "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—á—Ç–µ")

    text = f"""
üéâ –û—Ç–ª–∏—á–Ω–æ! –î–æ—Å—Ç—É–ø –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –ø–æ–ª—É—á–µ–Ω!

‚úÖ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ:

üìß –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–æ—á—Ç–∞ - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
üí¨ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã - –æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π
üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å - –≤—Å—Ç—Ä–µ—á–∏ –∏ —Å–æ–±—ã—Ç–∏—è
üìÅ –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ - —Ä–∞–±–æ—á–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
üîß –†–∞–±–æ—á–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã - —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏

–í–∞–∂–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã:
‚Ä¢ –ü–æ—Ä—Ç–∞–ª —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: {settings.PORTAL_URL if hasattr(settings, 'PORTAL_URL') else settings.COMPANY_SITE}
‚Ä¢ –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–±—ã—Ç–∏–π: {settings.CALENDAR_URL if hasattr(settings, 'CALENDAR_URL') else '–í –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–æ—á—Ç–µ'}
‚Ä¢ –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞: {settings.SUPPORT_EMAIL}

üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ?
–î–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è —Å –∫–æ–º–∞–Ω–¥–æ–π –∏ —É–∑–Ω–∞–µ–º –æ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö!
"""

    keyboard = Keyboards.get_onboarding_next()
    await query.edit_message_text(text, reply_markup=keyboard)


async def handle_email_not_received(query, context):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—á—Ç–µ"""
    user_id = query.from_user.id
    db_manager.log_user_action(user_id, "email_access_issue", "–ù–µ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–æ—á—Ç–µ")

    text = f"""
üòî –ù–µ –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç—É–ø? –†–µ—à–∏–º —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É!

üîß –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
‚Ä¢ –ü–∏—Å—å–º–æ –ø–æ–ø–∞–ª–æ –≤ —Å–ø–∞–º
‚Ä¢ –£–∫–∞–∑–∞–Ω–∞ –Ω–µ–≤–µ—Ä–Ω–∞—è –ø–æ—á—Ç–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏
‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ —Å–∏—Å—Ç–µ–º–µ

üìû –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ HR-–º–µ–Ω–µ–¥–∂–µ—Ä—É:

üë§ –§–µ–¥–æ—Å–µ–µ–Ω–∫–æ –°. –ú.
üìß Email: {settings.HR_EMAIL}
üì± Telegram: {settings.HR_TELEGRAM}
üìû –¢–µ–ª–µ—Ñ–æ–Ω: {settings.HR_PHONE if hasattr(settings, 'HR_PHONE') else '+7 (xxx) xxx-xx-xx'}

üí¨ –ß—Ç–æ —Å–æ–æ–±—â–∏—Ç—å HR:
"–ù–µ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–æ—á—Ç–µ –¥–ª—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞. –ú–æ–π ID –≤ –±–æ—Ç–µ: {user_id}"

‚è∞ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã HR: –ü–Ω-–ü—Ç 9:00-18:00

–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å —Å—é–¥–∞ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞.
"""

    keyboard = Keyboards.get_email_retry()
    await query.edit_message_text(text, reply_markup=keyboard)


async def handle_team_intro(query, context):
    """–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–º–∞–Ω–¥–æ–π"""
    user_id = query.from_user.id

    db_manager.update_user_stage(user_id, OnboardingStage.MEETINGS)
    db_manager.log_user_action(user_id, "team_intro", "–ò–∑—É—á–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∞–Ω–¥–µ")

    text = f"""
üë• –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–º–∞–Ω–¥–æ–π {settings.COMPANY_NAME}

üåê –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∞–π—Ç —Å –∫–æ–º–∞–Ω–¥–æ–π:
{settings.TEAM_PAGE}

üìä –ß—Ç–æ –≤—ã –Ω–∞–π–¥–µ—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ:
‚Ä¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - –∫—Ç–æ –∑–∞ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç
‚Ä¢ –ü—Ä–æ—Ñ–∏–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ - —Ñ–æ—Ç–æ, –¥–æ–ª–∂–Ω–æ—Å—Ç–∏, –Ω–∞–≤—ã–∫–∏
‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –∫—Ç–æ –∫ –∫–æ–º—É –æ–±—Ä–∞—â–∞—Ç—å—Å—è
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–¥–µ–ª–æ–≤ - –∫–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞

üë§ –í–∞—à –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–æ—á—Ç—É
‚Ä¢ –û–Ω —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –ø–µ—Ä–≤—ã–µ –¥–Ω–∏ —Ä–∞–±–æ—Ç—ã
‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –ø–ª–∞–Ω –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∏ –∑–∞–¥–∞—á–∏

üìñ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
{settings.HANDBOOK_URL}

–í —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ:
‚Ä¢ –ü—Ä–∞–≤–∏–ª–∞ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∫–æ–º–ø–∞–Ω–∏–∏
‚Ä¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã
‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç—ã –≤—Å–µ—Ö –æ—Ç–¥–µ–ª–æ–≤
‚Ä¢ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å —Å–∏—Å—Ç–µ–º–∞–º–∏
‚Ä¢ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã

üí° –°–æ–≤–µ—Ç: –ò–∑—É—á–∏—Ç–µ —ç—Ç–∏ —Ä–µ—Å—É—Ä—Å—ã –≤ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è - —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –≤–ª–∏—Ç—å—Å—è –≤ –∫–æ–º–∞–Ω–¥—É!
"""

    keyboard = Keyboards.get_team_intro_next()
    await query.edit_message_text(text, reply_markup=keyboard)


async def handle_meetings_info(query, context):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–Ω–µ—Ä–∫–∞—Ö –∏ –≤—Å—Ç—Ä–µ—á–∞—Ö"""
    user_id = query.from_user.id

    db_manager.update_user_stage(user_id, OnboardingStage.COMPLETE)
    db_manager.log_user_action(user_id, "meetings_info", "–ò–∑—É—á–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞–Ω–µ—Ä–∫–∞—Ö")

    text = f"""
üìÖ –ü–ª–∞–Ω–µ—Ä–∫–∏ –∏ –≤—Å—Ç—Ä–µ—á–∏ –∫–æ–º–∞–Ω–¥—ã

üîó –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏:

üè¢ –û–±—â–∞—è –ø–ª–∞–Ω–µ—Ä–∫–∞
‚Ä¢ –°—Å—ã–ª–∫–∞: {settings.MEETING_GENERAL}
‚Ä¢ –í—Ä–µ–º—è: –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 10:00
‚Ä¢ –£—á–∞—Å—Ç–Ω–∏–∫–∏: –í—Å—è –∫–æ–º–∞–Ω–¥–∞
‚Ä¢ –¶–µ–ª—å: –û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –Ω–∞ –Ω–µ–¥–µ–ª—é

üíª IT-–æ—Ç–¥–µ–ª
‚Ä¢ –°—Å—ã–ª–∫–∞: {settings.MEETING_IT}  
‚Ä¢ –í—Ä–µ–º—è: –°—Ä–µ–¥–∞, 11:00
‚Ä¢ –£—á–∞—Å—Ç–Ω–∏–∫–∏: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞
‚Ä¢ –¶–µ–ª—å: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–¥–∞—á–∏

üìà –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥
‚Ä¢ –°—Å—ã–ª–∫–∞: {settings.MEETING_MARKETING}
‚Ä¢ –í—Ä–µ–º—è: –ü—è—Ç–Ω–∏—Ü–∞, 14:00
‚Ä¢ –£—á–∞—Å—Ç–Ω–∏–∫–∏: –û—Ç–¥–µ–ª –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞
‚Ä¢ –¶–µ–ª—å: –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –∏ —Ä–µ–∫–ª–∞–º–∞

üë• HR-–≤—Å—Ç—Ä–µ—á–∏
‚Ä¢ –°—Å—ã–ª–∫–∞: {settings.MEETING_HR if hasattr(settings, 'MEETING_HR') else '–í –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–µ'}
‚Ä¢ –í—Ä–µ–º—è: –ü–µ—Ä–≤–∞—è –ø—è—Ç–Ω–∏—Ü–∞ –º–µ—Å—è—Ü–∞, 15:00
‚Ä¢ –£—á–∞—Å—Ç–Ω–∏–∫–∏: –í—Å—è –∫–æ–º–∞–Ω–¥–∞
‚Ä¢ –¶–µ–ª—å: HR-–≤–æ–ø—Ä–æ—Å—ã, –∞–¥–∞–ø—Ç–∞—Ü–∏—è, feedback

üìß –í–∞–∂–Ω–æ:
‚Ä¢ –í—Å–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–æ—á—Ç—É
‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ –ø–ª–∞–Ω–µ—Ä–∫–∞—Ö –≤–∞—à–µ–≥–æ –æ—Ç–¥–µ–ª–∞
‚Ä¢ –ü—Ä–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—á–∞—Å—Ç–∏—è - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–π—Ç–µ –∑–∞—Ä–∞–Ω–µ–µ

üìù –ü–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è:
‚Ä¢ –ü–æ—Å–µ—Ç–∏—Ç–µ –æ–±—â—É—é –ø–ª–∞–Ω–µ—Ä–∫—É –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞
‚Ä¢ –£—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ –ø–ª–∞–Ω–µ—Ä–∫–µ –≤–∞—à–µ–≥–æ –æ—Ç–¥–µ–ª–∞
‚Ä¢ –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–æ–≤–µ–¥–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é –≤—Å—Ç—Ä–µ—á—É
"""

    keyboard = Keyboards.get_meetings_next()
    await query.edit_message_text(text, reply_markup=keyboard)


async def complete_onboarding(query, context):
    """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞"""
    user_id = query.from_user.id

    db_manager.update_user_stage(user_id, 10, UserStatus.COMPLETED)
    db_manager.log_user_action(user_id, "onboarding_completed", "–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª –æ–Ω–±–æ—Ä–¥–∏–Ω–≥")

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
    user = db_manager.get_user(user_id)
    admin_message = f"""
üéâ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω!

üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫: {user.full_name} (@{query.from_user.username})
üìä –°—Ç–∞—Ç—É—Å: –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω
üìÖ –î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: {format_datetime(datetime.now())}
üéØ –≠—Ç–∞–ø–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: 10/10

–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!
"""

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
    for admin_id in settings.ADMIN_IDS:
        try:
            await context.bot.send_message(chat_id=admin_id, text=admin_message)
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {admin_id}: {e}")

    text = f"""
üéâüéä –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! üéäüéâ

–û–Ω–±–æ—Ä–¥–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!

–¢–µ–ø–µ—Ä—å –≤—ã –ø–æ–ª–Ω–æ–ø—Ä–∞–≤–Ω—ã–π —á–ª–µ–Ω –∫–æ–º–∞–Ω–¥—ã {settings.COMPANY_NAME}!

‚úÖ –ß—Ç–æ –≤—ã –ø—Ä–æ—à–ª–∏:
‚Ä¢ –ü—Ä–µ–±–æ—Ä–¥–∏–Ω–≥ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚Ä¢ –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–æ–≤  
‚Ä¢ –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–º–∞–Ω–¥–æ–π –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–Ω–µ—Ä–∫–∞—Ö –∏ –≤—Å—Ç—Ä–µ—á–∞—Ö

üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ:
‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ —É—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ –ø–ª–∞–Ω–µ—Ä–∫–∞—Ö –≤–∞—à–µ–≥–æ –æ—Ç–¥–µ–ª–∞
‚Ä¢ –ò–∑—É—á–∞–π—Ç–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
‚Ä¢ –û–±—â–∞–π—Ç–µ—Å—å —Å –∫–æ–ª–ª–µ–≥–∞–º–∏ –∏ –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –†–∞–∑–≤–∏–≤–∞–π—Ç–µ—Å—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ–º–∞–Ω–¥—ã

üìû –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å:
‚Ä¢ ‚ùì FAQ - –æ—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã - —Å–≤—è–∑—å —Å –∫–æ–ª–ª–µ–≥–∞–º–∏
‚Ä¢ üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞ - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å
‚Ä¢ üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å - –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –º–Ω–µ–Ω–∏–µ–º

üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É!
–ñ–µ–ª–∞–µ–º —É—Å–ø–µ—Ö–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º —Ä–æ—Å—Ç–µ!

---
*–≠—Ç–æ—Ç –±–æ—Ç –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–ø—Ä–∞–≤–æ–∫ –∏ –ø–æ–º–æ—â–∏.*
"""

    await query.edit_message_text(text)


async def get_onboarding_status(user_id: int) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user = db_manager.get_user(user_id)

    if not user:
        return "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"

    if user.status in [UserStatus.NEW, UserStatus.PREBOARDING]:
        return "–ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω (–∑–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–µ–±–æ—Ä–¥–∏–Ω–≥)"
    elif user.status == UserStatus.PREBOARDED:
        return "–ì–æ—Ç–æ–≤ –∫ –Ω–∞—á–∞–ª—É"
    elif user.status == UserStatus.ONBOARDING:
        stage_status = {
            OnboardingStage.ONBOARDING_START: "–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞",
            OnboardingStage.EMAIL_ACCESS: "–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–≤",
            OnboardingStage.TEAM_INTRO: "–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–º–∞–Ω–¥–æ–π",
            OnboardingStage.MEETINGS: "–ò–∑—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–µ—Ä–æ–∫",
        }
        return stage_status.get(user.stage, f"–≠—Ç–∞–ø {user.stage}")
    elif user.status == UserStatus.COMPLETED:
        return "–ó–∞–≤–µ—Ä—à–µ–Ω ‚úÖ"
    else:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å"